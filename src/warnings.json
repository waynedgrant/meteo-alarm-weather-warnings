<?php header('content-type: application/json; charset=utf-8');

# Copyright 2016 Wayne D Grant (www.waynedgrant.com)
# Licensed under the MIT License

require_once("Warnings.php");
require_once("Region.php");
require_once("Warning.php");
require_once("Awareness.php");
require_once("AwarenessLevel.php");
require_once("AwarenessType.php");
require_once("Period.php");
require_once("Description.php");

define('OUTPUT_TIMEZONE', 'Europe/London'); // TODO - Make this a param, perhaps optional?

if (!isset($_GET['country'])) { // TODO - more informative error reporting
    http_response_code(400);
    die();
}

$rss = fix_rss_ampersand_escaping(file_get_contents(generate_rss_link()));
$warnings = new Warnings(simplexml_load_string($rss), OUTPUT_TIMEZONE);

$json = json_encode($warnings->serialize());

echo isset($_GET['callback']) ? "{$_GET['callback']}($json)" : $json;

function generate_rss_link() {
    $country = $_GET['country'];

    if (isset($_GET['region'])) {
        // e.g. http://meteoalarm.eu/documents/rss/uk/UK004.rss
        return 'http://meteoalarm.eu/documents/rss/' . strtolower($country) . '/' . strtoupper($country) . $_GET['region'] . '.rss';
    } else {
        // http://www.meteoalarm.eu/documents/rss/uk.rss
        return 'http://www.meteoalarm.eu/documents/rss/' . strtolower($country) . '.rss';
    }

}

function fix_rss_ampersand_escaping($rss) {
    /* Some ampersands are escaped in the received RSS and some are not.
       Address this by escaping them and then fixing any resultant double escapes */
    $rss = str_replace('&', '&amp;', $rss);
    $rss = str_replace('&amp;amp;', '&amp;', $rss);
    return $rss;
}

?>
